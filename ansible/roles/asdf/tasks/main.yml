---
# ASDF Version Manager Role
# Installs ASDF, Python, and Node.js with latest stable versions

# ASDF Installation
- name: Check if ASDF is installed
  ansible.builtin.stat:
    path: ~/.asdf/asdf.sh
  register: asdf_check

- name: Install ASDF (via Homebrew)
  community.general.homebrew:
    name: asdf
    state: present
  become: false
  when: not asdf_check.stat.exists

- name: Add ASDF to shell configuration
  ansible.builtin.lineinfile:
    path: ~/.zshrc
    line: '. ~/.asdf/asdf.sh'
    insertafter: EOF
    state: present
  when: not asdf_check.stat.exists

# Python Plugin
- name: Check if Python plugin is installed
  ansible.builtin.shell: asdf plugin list | grep -w python && echo "installed" || echo "not installed"
  register: python_plugin_check
  changed_when: false
  ignore_errors: true

- name: Add Python plugin to ASDF
  ansible.builtin.command:
    cmd: asdf plugin add python
  when: python_plugin_check.stdout == "not installed"
  changed_when: true

- name: Get latest stable Python version
  ansible.builtin.command:
    cmd: asdf latest python
  register: python_latest_version
  changed_when: false

- name: Install latest stable Python
  ansible.builtin.command:
    cmd: "asdf install python {{ python_latest_version.stdout | trim }}"
  register: python_install_result
  changed_when: "'is already installed' not in python_install_result.stdout"

- name: Set Python as global default (using .tool-versions)
  ansible.builtin.command:
    cmd: "asdf set -u python {{ python_latest_version.stdout | trim }}"
  when: python_install_result.changed

# Node.js Plugin
- name: Check if Node.js plugin is installed
  ansible.builtin.shell: asdf plugin list | grep -w nodejs && echo "installed" || echo "not installed"
  register: nodejs_plugin_check
  changed_when: false
  ignore_errors: true

- name: Add Node.js plugin to ASDF
  ansible.builtin.command:
    cmd: asdf plugin add nodejs
  when: nodejs_plugin_check.stdout == "not installed"
  changed_when: true

- name: Get latest stable Node.js version
  ansible.builtin.command:
    cmd: asdf latest nodejs
  register: nodejs_latest_version
  changed_when: false

- name: Install latest stable Node.js
  ansible.builtin.command:
    cmd: "asdf install nodejs {{ nodejs_latest_version.stdout | trim }}"
  register: nodejs_install_result
  changed_when: "'is already installed' not in nodejs_install_result.stdout"

- name: Set Node.js as global default (using .tool-versions)
  ansible.builtin.command:
    cmd: "asdf set -u nodejs {{ nodejs_latest_version.stdout | trim }}"
  when: nodejs_install_result.changed

# Reshim
- name: Reshim ASDF for Python
  ansible.builtin.command:
    cmd: asdf reshim python
  changed_when: false

- name: Reshim ASDF for Node.js
  ansible.builtin.command:
    cmd: asdf reshim nodejs
  changed_when: false

# Summary
- name: Display installed versions
  ansible.builtin.debug:
    msg: |
      ASDF Setup Complete!
      Python: {{ python_latest_version.stdout | trim }}
      Node.js: {{ nodejs_latest_version.stdout | trim }}
      Global versions set in ~/.tool-versions
